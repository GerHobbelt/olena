\documentclass{report}

%\usepackage{hevea}

\usepackage{graphicx}
\usepackage{listings}
\usepackage{makeidx}
\usepackage{xcolor}
\usepackage{color}
\usepackage{html}
\usepackage{tikz}
\usepackage{pgf}

\newcommand{\img}[4]{
\begin{figure}[ht!]
	\begin{center}
      \includegraphics[width=#2]{figures/#1}
     \caption{#4\label{fig:#1}}
   \end{center}
 \end{figure}
}

\title{Olena -- Tutorial}
\author{LRDE}
\date{}
\makeindex

\definecolor{ccomment}{rgb}{0.5,0,0}
\definecolor{cstring}{rgb}{0,0.32,0.5}
\definecolor{cidentifier}{rgb}{0,0.5,0}
\definecolor{cbg}{rgb}{0.95,0.95,0.95}

%%%LISTINGS SETTINGS
%\begin{latexonly}
\lstset{frameround=fttt}
\lstloadlanguages{[ISO]C++}
\lstset{language=[ISO]C++,
  captionpos=b,
  basicstyle={\small\sffamily}, % normal small footnotesize scriptsize tiny
  commentstyle=\itshape,
  showstringspaces=false,
  numberstyle=\tiny,
  morekeywords={where, auto, concept, concept_map, axiom, late_check, final, abstract},
  morecomment=[s]{/*}{*/},
  backgroundcolor=\color{cbg},
  identifierstyle=\color{black},
  stringstyle=\color{cstring}
}
%\end{latexonly}

% #1 : sub page name
% #2 : sub page title
\newcommand{\doxychapter}[2]{%
\label{#1}
\backslash endhtmlonly%
\backslash page #1 #2%
\backslash htmlonly %
}

% #1 : section name
% #2 : section title
\newcommand{\doxysection}[2]{%
\vspace{1cm}
\label{#1}
\backslash endhtmlonly%
\backslash section #1 #2%
\backslash htmlonly %
}
\newcommand{\doxysubsection}[2]{%
\label{#1}
\backslash endhtmlonly%
\backslash subsection #1 #2%
\backslash htmlonly %
}

\newcommand{\doxysubsubsection}[2]{%
\label{#1}
\backslash endhtmlonly%
\backslash subsubsection #1 #2%
\backslash htmlonly %
}

% #1 - part number (Optional)
% #2 - file name
\newcommand{\doxycode}[2][1]{
\backslash endhtmlonly%
\backslash include #2-#1.cc%
\backslash htmlonly %
}

\newcommand{\doxyrawcode}[1]{
\backslash endhtmlonly%
\backslash include #1.cc.raw%
\backslash htmlonly %
}

\newcommand{\doxyoutput}[1]{
\backslash endhtmlonly%
\backslash include #1.txt%
\backslash htmlonly %
}

% Include file '#1' from a split output.
% #1 - part number (Optional)
% #2 - file name
\newcommand{\doxymoutput}[2][1]{
\backslash endhtmlonly%
\backslash include #2-#1.txt%
\backslash htmlonly %
}

\newcommand{\doxyfigure}[3][1]{
\backslash endhtmlonly%
\backslash image html #2-#1.png%
\backslash htmlonly %
}

\newcommand{\doxyimg}[2]{
\backslash endhtmlonly%
\backslash image html #1.png%
\backslash htmlonly %
}

\newcommand{\doxyref}[1]{
\backslash endhtmlonly%
\backslash ref #1%
\backslash htmlonly %
}

\newcommand{\doxysee}[1]{
\backslash endhtmlonly%
\backslash see #1%
\backslash htmlonly %
}

\newcommand{\tutotoc}[2]{%
\begin{center}%
  \longleftarrow ~Go to \doxyref{#1} \hspace{1cm} | \hspace{1cm} Go to \doxyref{#2}~ \longrightarrow%
\end{center}%
}

\newenvironment{doxymath}
{
%\backslash endhtmlonly%
%\backslash f\$
%\begin{rawtext}
$$
}
{
$$
%\end{rawtext}
%\backslash f\$
%\backslash htmlonly%
}

%\begin{latexonly}
\renewcommand{\doxychapter}[2]{\chapter{#2}\label{#1}}
\renewcommand{\doxysection}[2]{\section{#2}\label{#1}}
\renewcommand{\doxysubsection}[2]{\subsection{#2}\label{#1}}
\renewcommand{\doxysubsubsection}[2]{\subsubsection{#2}\label{#1}}
\renewcommand{\doxycode}[2][1]{\lstinputlisting[frame=single]{examples/#2-#1.cc}}
\renewcommand{\doxyrawcode}[1]{\lstinputlisting[frame=single]{examples/#1.cc.raw}}
\renewcommand{\doxyoutput}[1]{\lstinputlisting[frame=single]{outputs/#1.txt}}
\renewcommand{\doxymoutput}[2][1]{\lstinputlisting[frame=single]{outputs/splitted/#2-#1.txt}}
\renewcommand{\doxyfigure}[3][1]{%
\pgfimage[width=#3]{figures/#2-#1}%
\label{#1}%
}
\renewcommand{\doxyimg}[2]{%
\pgfimage[width=#2]{#1.png}%
\label{#1}%
}
\renewcommand{\doxyref}[1]{\ref{#1}}
\renewcommand{\doxysee}[1]{\ref{#1}}
\renewcommand{\tutotoc}[2]{}
\renewenvironment{doxymath}
{
  $$
}
{
  $$
}

%\end{latexonly}


\newcommand{\code}[1]{%
\textit{#1}%
}
\newcommand{\var}[1]{%
\textit{$#1$}%
}
\newcommand{\val}[1]{%
\textit{#1}%
}
\newcommand{\type}[1]{%
\textit{#1}%
}
\newcommand{\namespace}[1]{%
\textit{#1}%
}
\newcommand{\header}[1]{%
\textit{#1}%
}
\newcommand{\hpath}[1]{%
\textit{#1}%
}

\newcommand{\must}{%
\textbf{must}
}
\newcommand{\should}{%
\textbf{should}
}


\usetikzlibrary{er}

\newcommand{\neighcfour}{%
\begin{latexonly}
\begin{tikzpicture}%
  \tikzstyle{every entity}=[draw=blue!50,fill=blue!20,thick]%
  %center
  \draw (0,0) node[fill=orange!20,draw=orange] {} ;
  %left
  \draw (-0.25,0) node[entity,draw] {};
  %right
  \draw (0.26,0) node[entity,draw] {};%
  %top
  \draw (0,0.25) node[entity,draw] {};%
  %bottom
  \draw (0,-0.25) node[entity,draw] {};%
\end{tikzpicture}%
\end{latexonly}
}

\newcommand{\neighceight}{%
\begin{latexonly}
\begin{tikzpicture}%
  \tikzstyle{every entity}=[draw=blue!50,fill=blue!20,thick]%
  %center
  \draw (0,0) node[fill=orange!20,draw=orange] {} ;
  %left
  \draw (-0.25,0) node[entity,draw] {};
  %right
  \draw (0.26,0) node[entity,draw] {};%
  %top
  \draw (0,0.25) node[entity,draw] {};%
  %bottom
  \draw (0,-0.25) node[entity,draw] {};%
  %Top left
  \draw (-0.25,0.25) node[entity,draw] {};
  %Top right
  \draw (0.26,0.25) node[entity,draw] {};%
  %Bottom left
  \draw (-0.25,-0.25) node[entity,draw] {};%
  %Bottom Right
  \draw (0.26,-0.25) node[entity,draw] {};%
\end{tikzpicture}%
\end{latexonly}
}

\newcommand{\wincfour}{%
\begin{latexonly}
\begin{tikzpicture}%
  \tikzstyle{every entity}=[draw=blue!50,fill=blue!20,thick]%
  %center
  \draw (0,0) node[entity,draw] {} ;
  %left
  \draw (-0.25,0) node[entity,draw] {};
  %right
  \draw (0.26,0) node[entity,draw] {};%
  %top
  \draw (0,0.25) node[entity,draw] {};%
  %bottom
  \draw (0,-0.25) node[entity,draw] {};%

\end{tikzpicture}%
\end{latexonly}
}

\newcommand{\winceight}{%
\begin{latexonly}
\begin{tikzpicture}%
  \tikzstyle{every entity}=[draw=blue!50,fill=blue!20,thick]%
  %center
  \draw (0,0) node[entity,draw] {} ;
  %left
  \draw (-0.25,0) node[entity,draw] {};
  %right
  \draw (0.26,0) node[entity,draw] {};%
  %top
  \draw (0,0.25) node[entity,draw] {};%
  %bottom
  \draw (0,-0.25) node[entity,draw] {};%
  %Top left
  \draw (-0.25,0.25) node[entity,draw] {};
  %Top right
  \draw (0.26,0.25) node[entity,draw] {};%
  %Bottom left
  \draw (-0.25,-0.25) node[entity,draw] {};%
  %Bottom Right
  \draw (0.26,-0.25) node[entity,draw] {};%
\end{tikzpicture}%
\end{latexonly}
}

\begin{document}

% Doxygen use only - Generate the left menu.
%Write foreword below.
\begin{htmlonly}
\backslash endhtmlonly

\backslash page tutorial Tutorial
- \backslash subpage tuto0
- \backslash subpage tuto1
- \backslash subpage tuto2
- \backslash subpage tuto3
- \backslash subpage tuto4
- \backslash subpage tuto5
- \backslash subpage tuto6
- \backslash subpage tuto7

\backslash htmlonly
\end{htmlonly}

\begin{latexonly}
\maketitle

\section*{Copying this document}
Copyright \copyright{} 2008, 2009 LRDE.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.2 or any later
version published by the Free Software Foundation; with the Invariant Sections
being just ``Copying this document'', no Front-Cover Texts, and no Back-Cover
Texts.

A copy of the license is provided in the file COPYING.DOC.

\tableofcontents
\end{latexonly}

%\begin{htmlonly}
%====================================
\doxychapter{tuto0}{Step 0: Foreword}

- image2d
- typical use case

\begin{htmlonly}
  \begin{center}%
    \hspace{1cm} Go to \doxyref{tuto1}~ \longrightarrow%
  \end{center}%
\end{htmlonly}



%====================================
\doxychapter{tuto1}{Step 1: Load and save images}

After this step you shoud know how to:
\begin{itemize}
\item load an image,
\item save an image.
\end{itemize}

\vspace{2cm}
Currently, Olena supports the following input image formats:
\begin{itemize}
  \item PBM
  \item PFM
  \item PGM
  \item PNM
  \item PPM 
\end{itemize}

This support is provided through two headers for each type, \header{save.hh} and
\header{load.hh}.
They are located in \hpath{mln/io/$<$image-format$>$/}.

Once the right header is included, the image can be loaded:

\doxycode{ima-load}

If you wan to save an image, simply call the save routine in the proper namespace:
\doxycode{ima-save}

According to the image value type, the proper file format must be chosen.
The supported file formats and their associated image value types are listed
in section \doxyref{imaio}.

\vspace{2cm}
\tutotoc{tuto0}{tuto2}



%====================================
\doxychapter{tuto2}{Step 2: Create your first image}

After this step you should know how to:
  \begin{itemize}
    \item create an image,
    \item display an image in console mode.
  \end{itemize}

\doxysee{tuto2_first_image.cc}


\vspace{2cm}
First, declare an array of bool which will represent the image grid. Each each
cell in this grid is a site and each cell contains a value, \val{true} or
\val{false}.
\doxycode[1]{tuto2_first_image}

From that grid, simply call make::image to get an image initialized with that
data.
\doxycode[2]{tuto2_first_image}
This way of initializing an image is the most common one. However, there are
several other ways described in section \doxyref{imacreate}.


To be sure that the data is correctly initialized, it is possible to display the
image in the standard output using debug::println.
\doxycode[3]{tuto2_first_image}
Output:
\doxyoutput{tuto2_first_image}

Finally, you may want to save the image. Since we use bool as image value, the
PBM format is the best choice. Therefore, we use io::pbm::save.
\doxycode[4]{tuto2_first_image}

The output image looks like the following:
\doxyfigure{tuto2_first_image}{3cm}

In this first step we used a boolean image. Many other value types are available
though. A more detailed description can be found in section
\doxyref{imapossvalues}.

\vspace{2cm}
\begin{center}
  \tutotoc{tuto1}{tuto3}
\end{center}


%====================================
\doxychapter{tuto3}{Step 3: Read and write images}

After this step you should know how to:
  \begin{itemize}
    \item modify/initialize image values,
    \item copy and paste data to an image.
  \end{itemize}


\doxysee{tuto3_rw_image.cc}

\vspace{2cm}
First create an empty color image with a \var{box2d} of 40x40 as domain.
\doxycode[1]{tuto3_rw_image}

If you want to initialize the image with the color red, simply call data::fill as follows:
\doxycode[2]{tuto3_rw_image}

Updating a site value is also possible using \code{operator()} or the
\code{opt::at()} routine. Here we create a blue square of 10x10 pixels from site
(20, 20) to (30, 30).
\doxycode[3]{tuto3_rw_image}
\doxycode[4]{tuto3_rw_image}

The corresponding image:
\doxyfigure[1]{tuto3_rw_image}{3cm}

An image can also be initialized/modified thanks to another image.
Let's load a new image.
\doxycode[5]{tuto3_rw_image}
\var{lena} looks like:
\doxyimg{small-enlarged}{3cm}

If we want to initialize \var{ima} with \var{lena}, we can use \code{data::fill}:
\doxycode[6]{tuto3_rw_image}
Output:
\doxyfigure[2]{tuto3_rw_image}{3cm}
Note that to fill an image with some data, the image domain \must be smaller
or equal to the data.

Likewise, it is possible to paste data from an image to another:
\doxycode[7]{tuto3_rw_image}
Output:
\doxyfigure[3]{tuto3_rw_image}{3cm}

More details can be found in sections \doxyref{imaaccessmodval}, \doxyref{fillop} and \doxyref{pasteop} in
the reference guide.

\vspace{2cm}
\begin{center}
  \tutotoc{tuto2}{tuto4}
\end{center}


%====================================
\doxychapter{tuto4}{Step 4: Regions of interest}

After this step you should know how to:
  \begin{itemize}
    \item take benefit of Olena's genericity,
    \item work only on a region of interest in an image.
  \end{itemize}

\doxysee{tuto4_genericity_and_algorithms.cc}
\vspace{2cm}

In the previous step, we used the routine \code{data::fill} in order to change
the values of an image. It was convenient since we did not need to write any
loop by hand. The problem was that we could not specificy which region to fill
with data. This point leads us to talk about the genericity in Olena.
All along this example we will use the routine \code{data::fill} to illustrate
the possibilities in Olena but note that every image types passed to the
routine in this example could be passed to any algorithm in the library
expecting an image.

One main feature of Olena is to be able to easily work on regions of interest in
images. According to the way a region of interest is defined, a specific image
type is associated. Therefore, each algorithm knows exactly what it is working
on and can behave differently in order to be the most efficient as possible.


All along this step, we will use the following image \var{lena} declared as
follow:

\doxycode[1]{tuto4_genericity_and_algorithms}
\doxyimg{small-enlarged}{3cm}

\code{data::fill} has the following prototype:
\doxyrawcode{fill-proto}
So keep in mind that the first argument we will try to construct in each
example is an image. Note that this image \must be writable, e.g. non-const.


%**************************
\doxysection{tuto4imadomainsiteset}{Image domain restricted by a site set}

Here, we would like to fill a small square with green in \var{lena}. We want
this square to be of size 20x20 and to be located at (20,20).
First, we just need to declare this square which is actually a site set, a
\type{box2d}.
\doxycode[2]{tuto4_genericity_and_algorithms}

Then, we just need to tell \code{data::fill} that we would like to fill the
image \var{lena} but only in this restricted part of the image domain. 
\doxycode[3]{tuto4_genericity_and_algorithms}
Operator '|' can be read 'restricted to'. So below, we wrote 'image \var{lena}
restricted to the region of interest \var{roi}'. Actually this is not directly
\var{lena} which is restricted but its domain.

Note the use of \code{rw()} which is mandatory due to C++ limitations. In C++,
the image created by \code{lena | roi} is \code{const}, e.g. read-only, though
\code{data::fill} expect a \code{non-const} image, e.g. read-write. \code{rw()}
is a workaround to make it read-write.

\begin{center}
  \begin{tabular}{c c c}
    \doxyimg{small-enlarged}{3cm} & ~\huge{$\rightarrow$}~ & \doxyfigure[1]{tuto4_genericity_and_algorithms}{3cm} \\
    \multicolumn{3}{c}{Fill with blue a region of interest defined by a
      \type{box2d}.} \\
  \end{tabular}
\end{center}


%**************************
\doxysection{tuto4imadomainfun}{Image domain restricted by a function}

Sometimes it may not be easy to construct a site set to restrict an image. For
instance, if we would like to fill with green one point out of two in the whole
image, we \textbf{do not want} to write anyloop or construct any site set by hand:
\doxycode[4]{tuto4_genericity_and_algorithms}
\doxycode[5]{tuto4_genericity_and_algorithms}

A shorter way to get exactly the same result, is to define that behavior by a
function. In Milena, a function \code{fun::p2v::chess} is available and does
exactly what we want. Like if it was a site set, simply restrict the image with
the function.

\doxycode[6]{tuto4_genericity_and_algorithms}
\begin{center}
  \begin{tabular}{c c c}
    \doxyimg{small-enlarged}{3cm} & ~\huge{$\rightarrow$}~ & \doxyfigure[2]{tuto4_genericity_and_algorithms}{3cm} \\
    \multicolumn{3}{c}{Fill with green a region of interest defined by a
      \type{Function}.} \\
  \end{tabular}
\end{center}

Note that the functions provided by default in Olena are actually functors.
Thus, they must be constructed like any object which why it is written
\code{lena | fun::p2v::chess()} and not \code{lena | fun::p2v::chess}.


FIXME: Talk about C functions once it is possible in Milena.


%**************************
\doxysection{tuto4imadomainmask}{Image domain restricted by a mask}

Sometimes instead of having a site site or a function defining the regions of
interest we want to work on, we may have a binary image, e.g. a mask. When a
site has its value set to true, it means it will be considered as part of the
masked image domain. Otherwise, it will not.

We construct a mask, \var{mask}. It is initialized with the same geometry properties as
\var{lena}
(domain, extension...).
\doxycode[7]{tuto4_genericity_and_algorithms}

Then, we cannot restrict directly \var{lena} with \var{mask}. These two images
have the same domain, so \code{lena | mask.domain()} would not do anything.
\var{mask} is a classical image, there is not specific type for mask images.
Therefore, we need to express that we want that binary image to be considered as
a mask.
\doxycode[8]{tuto4_genericity_and_algorithms}
\code{pw::value(mask)} makes explicit the fact that \var{mask} is actually a
mask. It means, that for each site of \var{mask}, if its value is set to
\val{true}, then the value associated to this site in \var{lena} must be set
to green.
In this example, we use two images for two different use case: \var{lena} store
the result and the modifications make by the algorithm and \var{mask} allows the
algorithm to know whether it must treat a site or not.

\begin{center}
  \begin{tabular}{c c c c}
    \doxyimg{small-enlarged}{3cm}  &
    \doxyfigure[3]{tuto4_genericity_and_algorithms}{3cm} &
    ~\huge{$\rightarrow$}~ &
    \doxyfigure[4]{tuto4_genericity_and_algorithms}{3cm}  \\
    \multicolumn{4}{c}{Fill with green a region of interest defined by a mask
      image.} \\
  \end{tabular}
\end{center}


%**************************
\doxysection{tuto4imadomainpredicate}{Image domain restricted by a predicate}

Restricting by a predicate is exactly like restricting with a function. We want
to talk about that separately in order to present the small routines available.
They enable the user to write quick and efficient predicate/function.

The two routines are :
\begin{itemize}
  \item pw::value(Image), as seen in a previous section, it is a way to express
  'for each site value in Image'.
  \item pw::cst(Value), it is a way to specify a value to which a site value can
  be compared.
\end{itemize}

Let's see a common use case. 
First, we binarize lena according to specific criterions, only site values with
specific colors are set to true in \var{lena_bw}. Others are set to false. This
image will be used in order to label the components.
Let's consider a labeled image \var{label}. Each component of \var{lena} is labeled with a unique index.
Now, we consider that that our region of interest is a component with id 16.
Then we want to express 'for each site \var{fill} its value in \var{lena} if its
value in \var{label} is equal to 16'.
\doxycode[9]{tuto4_genericity_and_algorithms}


\doxycode[10]{tuto4_genericity_and_algorithms}

\begin{center}
  \begin{tabular}{c c c c}
    \doxyimg{small-enlarged}{3cm}  &
    \doxyfigure[5]{tuto4_genericity_and_algorithms}{3cm} &
    ~\huge{$\rightarrow$}~ &
    \doxyfigure[6]{tuto4_genericity_and_algorithms}{3cm}  \\
    \multicolumn{4}{c}{Fill with green a region of interest defined by its
      label.} \\
  \end{tabular}
\end{center}


%**************************
\doxysection{tuto4component}{Image component restricted to a domain}

\doxycode[11]{tuto4_genericity_and_algorithms}

\begin{center}
  \begin{tabular}{c c c c}
    \doxyimg{small-enlarged}{3cm}  &
%   \doxyfigure[7]{tuto4_genericity_and_algorithms}{3cm} &
    ~\huge{$\rightarrow$}~ &
    \doxyfigure[8]{tuto4_genericity_and_algorithms}{3cm}  \\
    \multicolumn{4}{c}{Fill with green a region of interest defined by its
      label.} \\
  \end{tabular}
\end{center}



\doxycode[12]{tuto4_genericity_and_algorithms}

\begin{center}
  \begin{tabular}{c c c c}
    \doxyimg{small-enlarged}{3cm}  &
    ~\huge{$\rightarrow$}~ &
    \doxyfigure[9]{tuto4_genericity_and_algorithms}{3cm}  \\
    \multicolumn{4}{c}{Fill with green a region of interest defined by its
      label.} \\
  \end{tabular}
\end{center}


\vspace{2cm}
\begin{center}
  \tutotoc{tuto3}{tuto5}
\end{center}

%====================================%
%%Ugly workaround to avoid missing chapter references in doxygen.
%\begin{htmlonly}
%  \doxychapter{1}{}
%  \doxychapter{tuto5}{Step 5: Conversion between image values}
%\end{htmlonly}


%====================================
\doxychapter{tuto6}{Step 6: Using structural elements with algorithms}


%====================================
\doxychapter{tuto7}{Step 7: Handle graphes with an image}

%\end{htmlonly}


\end{document}
